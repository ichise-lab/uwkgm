#!/bin/bash

source bin/conf
source bin/packages

manage.run() {
    while true;
    do
        CHOICES=(
            "API server"
            "UI server"
        )

        VALUES=(
            api
            ui
        )

        args.pull OPERATION
        inputs.choices OPERATION "Run Server" "Choose server to run" "api" "$OPERATION" "${CHOICES[@]}" "${VALUES[@]}"

        if [[ $OPERATION == "api" ]]; then
            manage.run.api
        elif [[ $OPERATION == "ui" ]]; then
            manage.run.ui
        elif [[ $OPERATION == "cancel" ]]; then
            return
        fi
    done
}

manage.run.api() {
    source conf/databases
    source conf/secrets
    source conf/servers

    manage.packages.site.run

    echo "[UWKGM: INFO] Preparing the API server..."

    export UWKGM_API_STATE=migrating
    python3 api/uwkgm/manage.py makemigrations accounts
    python3 api/uwkgm/manage.py makemigrations
    python3 api/uwkgm/manage.py migrate

    echo ""
    echo "[UWKGM: INFO] Starting the API server..."

    export UWKGM_API_STATE=running
    export DOREST_VERBOSE=true
    python3 api/uwkgm/manage.py runserver 0.0.0.0:8001
}

manage.run.ui() {
    source conf/servers
    
    export HOST=0.0.0.0
    export PORT=8000
    export REACT_APP_ENV=$UWKGM_ENV
    export REACT_APP_UI_VERSION=$UWKGM_UI_VERSION
    export REACT_APP_API_VERSION=$UWKGM_API_VERSION
    export REACT_APP_API_ENDPOINT=$UWKGM_API_ENDPOINT
    export REACT_APP_AUTH_ENDPOINT=$UWKGM_AUTH_ENDPOINT
    export REACT_APP_DEFAULT_LANGUAGE=$UWKGM_DEFAULT_LANGUAGE
    export REACT_APP_VISUALIZER_DEFAULT_LANGUAGE=$UWKGM_VISUALIZER_DEFAULT_LANGUAGE

    npm start --prefix ui/uwkgm
}