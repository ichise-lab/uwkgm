#!/bin/bash

source bin/libs/args
source bin/libs/inputs
source bin/libs/files
source conf/databases
source packages/virtuoso/package

packages.virtuoso.install() {
    while true;
    do
        CHOICES=(
            "Run a docker container"
            "Deploy Virtuoso in a Kubernetes cluster"
        )

        VALUES=(
            docker
            kube
        )

        args.pull INSTALL
        inputs.choices INSTALL "Install Virtuoso" "Choose installation" "docker" "$INSTALL" "${CHOICES[@]}" "${VALUES[@]}"

        if [[ $INSTALL == "docker" ]]; then
            packages.virtuoso.install.docker
        elif [[ $INSTALL == "kube" ]]; then
            packages.virtuoso.install.kube
        elif [[ $INSTALL == "cancel" ]]; then
            return
        fi
    done
}

packages.virtuoso.install.docker() {
    docker run --name uwkgm-virtuoso \
        --memory=32g \
        -p 8890:8890 -p 1111:1111 \
        -e DBA_PASSWORD=dba \
        -e SPARQL_UPDATE=true \
        -e DEFAULT_GRAPH=$UWKGM_DB_GRAPHS_DEFAULT_GRAPH \
        -e VIRT_Parameters_DirsAllowed="., /usr/local/virtuoso-opensource/share/virtuoso/vad, /import" \
        -e VIRT_Parameters_NumberOfBuffers=$UWKGM_PKG_VIRTUOSO_NUM_BUFFERS \
        -e VIRT_Parameters_MaxDirtyBuffers=$UWKGM_PKG_VIRTUOSO_DIRTY_BUFFERS \
        -v $UWKGM_DB_GRAPHS_HOST_PATH:/data \
        -v $UWKGM_DB_GRAPHS_IMPORT_PATH:/import \
        -d tenforce/virtuoso
}

packages.virtuoso.install.kube() {
    rm -r -f packages/virtuoso/temp
    mkdir -p packages/virtuoso/temp
    mkdir -p $UWKGM_PKG_VIRTUOSO_HOST_PATH
    mkdir -p $UWKGM_PKG_VIRTUOSO_HOST_EXT_PATH

    cp packages/virtuoso/templates/virtuoso.ini.template packages/virtuoso/temp/virtuoso.ini
    cp packages/virtuoso/templates/virtuoso.yaml.template packages/virtuoso/temp/virtuoso.yaml

    files.text.replace "{{UWKGM_PKG_VIRTUOSO_NUM_BUFFERS}}" "$UWKGM_PKG_VIRTUOSO_NUM_BUFFERS" packages/virtuoso/temp/virtuoso.ini
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DIRTY_BUFFERS}}" "$UWKGM_PKG_VIRTUOSO_DIRTY_BUFFERS" packages/virtuoso/temp/virtuoso.ini
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH}}" "$UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH" packages/virtuoso/temp/virtuoso.ini

    files.text.replace "{{UWKGM_PKG_VIRTUOSO_HOST_PATH}}" "$UWKGM_PKG_VIRTUOSO_HOST_PATH" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_HOST_EXT_PATH}}" "$UWKGM_PKG_VIRTUOSO_HOST_EXT_PATH" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DOCKER_VERSION}}" "$UWKGM_PKG_VIRTUOSO_DOCKER_VERSION" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_PASSWORD}}" "$UWKGM_PKG_VIRTUOSO_PASSWORD" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH}}" "$UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH" packages/virtuoso/temp/virtuoso.yaml

    cp packages/virtuoso/temp/virtuoso.ini $UWKGM_PKG_VIRTUOSO_HOST_PATH/virtuoso.ini
    kubectl apply -f packages/virtuoso/temp/virtuoso.yaml

    rm -r -f packages/virtuoso/temp
}