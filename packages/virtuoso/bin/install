#!/bin/bash

source bin/libs/args
source bin/libs/inputs
source bin/libs/files
source packages/virtuoso/package

packages.virtuoso.install() {
    while true;
    do
        CHOICES=(
            "Deploy Virtuoso in a Kubernetes cluster"
        )

        VALUES=(
            kube
        )

        args.pull INSTALL
        inputs.choices INSTALL "Install Virtuoso" "Choose installation" "kube" "$INSTALL" "${CHOICES[@]}" "${VALUES[@]}"

        if [[ $INSTALL == "kube" ]]; then
            packages.virtuoso.install.kube
        elif [[ $INSTALL == "cancel" ]]; then
            return
        fi
    done
}

packages.virtuoso.install.kube() {
    rm -r -f packages/virtuoso/temp
    mkdir -p packages/virtuoso/temp
    mkdir -p $UWKGM_PKG_VIRTUOSO_HOST_PATH
    mkdir -p $UWKGM_PKG_VIRTUOSO_HOST_EXT_PATH

    cp packages/virtuoso/templates/virtuoso.ini.template packages/virtuoso/temp/virtuoso.ini
    cp packages/virtuoso/templates/virtuoso.yaml.template packages/virtuoso/temp/virtuoso.yaml

    files.text.replace "{{UWKGM_PKG_VIRTUOSO_NUM_BUFFERS}}" "$UWKGM_PKG_VIRTUOSO_NUM_BUFFERS" packages/virtuoso/temp/virtuoso.ini
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DIRTY_BUFFERS}}" "$UWKGM_PKG_VIRTUOSO_DIRTY_BUFFERS" packages/virtuoso/temp/virtuoso.ini
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH}}" "$UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH" packages/virtuoso/temp/virtuoso.ini

    files.text.replace "{{UWKGM_PKG_VIRTUOSO_HOST_PATH}}" "$UWKGM_PKG_VIRTUOSO_HOST_PATH" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_HOST_EXT_PATH}}" "$UWKGM_PKG_VIRTUOSO_HOST_EXT_PATH" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DOCKER_VERSION}}" "$UWKGM_PKG_VIRTUOSO_DOCKER_VERSION" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_PASSWORD}}" "$UWKGM_PKG_VIRTUOSO_PASSWORD" packages/virtuoso/temp/virtuoso.yaml
    files.text.replace "{{UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH}}" "$UWKGM_PKG_VIRTUOSO_DEFAULT_GRAPH" packages/virtuoso/temp/virtuoso.yaml

    cp packages/virtuoso/temp/virtuoso.ini $UWKGM_PKG_VIRTUOSO_HOST_PATH/virtuoso.ini
    kubectl apply -f packages/virtuoso/temp/virtuoso.yaml

    rm -r -f packages/virtuoso/temp
}